<!DOCTYPE html>
<html >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Building a global storage for Vapor - </title>
    <meta name="description" content="This tutorial is about a shared global storage that you can implement using a common design pattern in Vapor 4.">
    
    <meta property="og:url" content="/posts/building-a-global-storage-for-vapor/">
    <meta property="og:title" content="Building a global storage for Vapor - ">
    <meta property="og:description" content="This tutorial is about a shared global storage that you can implement using a common design pattern in Vapor 4.">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Building a global storage for Vapor - ">
    <meta name="twitter:description" content="This tutorial is about a shared global storage that you can implement using a common design pattern in Vapor 4.">
    
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

</head>

<body>
    <header id="navigation">
        <a id="site-logo" href="">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
        </a>
    
        <nav id="primary-menu">
            <input type="checkbox" id="primary-menu-button" name="menu-button" class="menu-button">
            <label for="primary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </label>
            <div class="menu-items">
                <a href="/">Home</a>
                <a href="/blog/">Blog</a>
                <a href="/posts/pages/1/">Posts</a>
                <a href="/authors/">Authors</a>
                <a href="/tags/">Tags</a>
                <a href="/my-page/">My page</a>
            </div>
        </nav>
    
        <nav id="secondary-menu">
            <input type="checkbox" id="secondary-menu-button" name="menu-button" class="menu-button">
            <label for="secondary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </label>
            <div class="menu-items right">
                <a href="#">My account</a>
                <a href="/">Logout</a>
            </div>
        </nav>
    </header>
        
    <main>

<article>
    <header>
        <section id="post-header" class="content-wrapper">
            <time datetime="2021-12-16 16:20:00">2021-12-16 16:20:00</time>
            <h1 class="title">Building a global storage for Vapor</h1>
            <p class="excerpt">This tutorial is about a shared global storage that you can implement using a common design pattern in Vapor 4.</p>
        </section>
        
    </header>

    <section id="contents" class="content-wrapper">
    
    <h2>The problem with app services</h2><p>Vapor has a thing called <a href="https://docs.vapor.codes/4.0/services/" target="_blank">services</a>, you can add new functionality to the system by following the pattern described in the documentation. Read-only services are great there is no issue with them, they always return a new instance of a given object that you want to access.</p><p>The problem is when you want to access a shared object or in other words, you want to define a writable service. In my case I wanted to create a shared cache dictionary that I could use to store some preloaded variables from the database.</p><p>My initial attempt was to create a writable service that I can use to store these key-value pairs. I also wanted to use a middleware and load everything there upfront, before the route handlers. üí°</p><pre><code class="language-swift">import Vapor

private extension Application {
    
    struct VariablesStorageKey: StorageKey {
        typealias Value = [String: String]
    }

    var variables: [String: String] {
        get {
            self.storage[VariablesStorageKey.self] ?? [:]
        }
        set {
            self.storage[VariablesStorageKey.self] = newValue
        }
    }
}

public extension Request {
    
    func variable(_ key: String) -> String? {
        application.variables[key]
    }
}

struct CommonVariablesMiddleware: AsyncMiddleware {

    func respond(to req: Request, chainingTo next: AsyncResponder) async throws -> Response {
        let variables = try await CommonVariableModel.query(on: req.db).all()
        var tmp: [String: String] = [:]
        for variable in variables {
            if let value = variable.value {
                tmp[variable.key] = value
            }
        }
        req.application.variables = tmp
        return try await next.respond(to: req)
    }
}
</code></pre><p>Now you might think that hey this looks nice and it‚Äôll work and you are right, it works, but there is a HUGE problem with this solution. It‚Äôs not thread-safe at all. ‚ö†Ô∏è</p><p>When you open the browser and type <code>http://localhost:8080/</code> the page will load, but when you start bombarding the server with multiple requests using multiple threads (<code>wrk -t12 -c400 -d30s http://127.0.0.1:8080/</code>) the application will simply crash.</p><p>There is a similar issue on <a href="https://github.com/vapor/vapor/issues/2330" target="_blank">GitHub</a>, which describes the exact same problem. Unfortunately I was unable to solve this with <a href="https://docs.vapor.codes/4.0/services/#locks" target="_blank">locks</a>, I don‚Äôt know why but it messed up even more things with strange errors and since I‚Äôm also not able to run instruments on my M1 Mac Mini, because Swift packages are not <a href="https://developer.apple.com/forums/thread/681687" target="_blank">code signed</a> by default. I‚Äôve spent so many hours on this and I‚Äôve got very frustrated.</p><h2>Building a custom global storage</h2><p>After a break this issue was still bugging my mind, so I‚Äôve decided to do some more research. <a href="https://discord.com/invite/vapor" target="_blank">Vapor‚Äôs discord</a> server is usually a great place to get the right answers.</p><p>I‚Äôve also looked up other web frameworks, and I was quite surprised that <a href="https://github.com/hummingbird-project/hummingbird" target="_blank">Hummingbird</a> offers an <a href="https://hummingbird-project.github.io/hummingbird/current/hummingbird/Classes/HBApplication/EventLoopStorage.html" target="_blank">EventLoopStorage</a> by default. Anyway, I‚Äôm not going to switch, but still it‚Äôs a nice to have feature.</p><p>As I was looking at the suggestions I realized that I need something similar to the <code>req.auth</code> property, so I‚Äôve started to investigate the <a href="https://github.com/vapor/vapor/blob/main/Sources/Vapor/Authentication/AuthenticationCache.swift" target="_blank">implementation</a> details more closely.</p><p>First, I removed the protocols, because I only needed a plain <code>[String: Any]</code> dictionary and a generic way to return the values based on the keys. If you take a closer look it‚Äôs quite a simple design pattern. There is a helper struct that stores the reference of the request and this struct has an private Cache class that will hold our pointers to the instances. The cache is available through a property and it is stored inside the <code>req.storage</code>.</p><pre><code class="language-swift">import Vapor

public extension Request {

    var globals: Globals {
        return .init(self)
    }

    struct Globals {
        let req: Request

        init(_ req: Request) {
            self.req = req
        }
    }
}

public extension Request.Globals {

    func get<T>(_ key: String) -> T? {
        cache[key]
    }
    
    func has(_ key: String) -> Bool {
        get(key) != nil
    }
    
    func set<T>(_ key: String, value: T) {
        cache[key] = value
    }
    
    func unset(_ key: String) {
        cache.unset(key)
    }
}


private extension Request.Globals {

    final class Cache {
        private var storage: [String: Any]

        init() {
            self.storage = [:]
        }

        subscript<T>(_ type: String) -> T? {
            get { storage[type] as? T }
            set { storage[type] = newValue }
        }
        
        func unset(_ key: String) {
            storage.removeValue(forKey: key)
        }
    }

    struct CacheKey: StorageKey {
        typealias Value = Cache
    }

    var cache: Cache {
        get {
            if let existing = req.storage[CacheKey.self] {
                return existing
            }
            let new = Cache()
            req.storage[CacheKey.self] = new
            return new
        }
        set {
            req.storage[CacheKey.self] = newValue
        }
    }
}
</code></pre><p>After changing the original code I‚Äôve come up with this solution. Maybe it‚Äôs still not the best way to handle this issue, but it works. I was able to store my variables inside a global storage without crashes or leaks. The <code>req.globals</code> storage property is going to be shared and it makes possible to store data that needs to be loaded asynchronously. üòÖ</p><pre><code class="language-swift">import Vapor

public extension Request {
    
    func variable(_ key: String) -> String? {
        globals.get(key)
    }
}

struct CommonVariablesMiddleware: AsyncMiddleware {

    func respond(to req: Request, chainingTo next: AsyncResponder) async throws -> Response {
        let variables = try await CommonVariableModel.query(on: req.db).all()
        for variable in variables {
            if let value = variable.value {
                req.globals.set(variable.key, value: value)
            }
            else {
                req.globals.unset(variable.key)
            }
        }
        return try await next.respond(to: req)
    }
}
</code></pre><p>After I‚Äôve run several more tests using <a href="https://github.com/wg/wrk" target="_blank">wrk</a> I was able to confirm that the solution works. I had no issues with threads and the app had no memory leaks. It was a relief, but still I‚Äôm not sure if this is the best way to handle my problem or not. Anyway I wanted to share this with you because I believe that there is not enough information about thread safety.</p><p>The introduction of <a href="https://theswiftdev.com/beginners-guide-to-the-asyncawait-concurrency-api-in-vapor-fluent/" target="_blank">async / await in Vapor</a> will solve many concurrency problems, but we‚Äôre going to have some new ones as well. I really hope that Vapor 5 will be a huge improvement over v4, people are already throwing in ideas and they are having discussions about the future of Vapor on discord. This is just the beginning of the async / await era both for Swift and Vapor, but it‚Äôs great to see that finally we‚Äôre going to be able to get rid of <a href="https://docs.vapor.codes/4.0/fluent/transaction/#asyncawait" target="_blank">EventLoopFutures</a>. ü•≥</p>
        
    </section>
    
    <h2>Next</h2>
    
    <h2>Prev</h2>
        <div class="post card">
            <a href="/posts/hummingbird-routing-and-requests/" target="">
                <figure>
                    <picture>
                        <img
                            src=""
                            alt=""
                            title=""
                        >
                    </picture>
                </figure>
                <section>
                    <time datetime="2023-03-17 16:20:00">2023-03-17 16:20:00</time>
                    <h2 class="title">Hummingbird routing and requests</h2>
                </section>
                <p>Beginner&#39;s guide to learn all about routing and request handling using the Hummingbird server-side Swift framework.</p>
            </a>
        
            
            
        
        </div>
    
    <h2>Related</h2>
    Empty.
    
    <h2>More by author(s)</h2>
    Empty.

</article>

    </main>

    <footer id="page-footer">
        <section class="content-wrapper">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
    
            <p>This site was generated using the <a href="https://swift.org/" target="_blank">Swift</a> programming language.</p>
            
            <p>
                <a href="https://binarybirds.com/">Home</a> ¬∑
                <a href="mailto:binarybirdsofficial@gmail.com">Email</a> ¬∑
                <a href="https://github.com/binarybirds/">GitHub</a> ¬∑
                <a href="https://x.com/tiborbodecs">Twitter</a> ¬∑
                <a href="/rss.xml" target="_blank">RSS</a> ¬∑
                <a href="/sitemap.xml" target="_blank">Sitemap</a>
            </p>
    
            <p class="small"> &copy; 2022 - 2024.</p>
        </section>
    </footer>
</body>
</html>
