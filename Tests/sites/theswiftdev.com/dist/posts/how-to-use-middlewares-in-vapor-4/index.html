<!DOCTYPE html>
<html >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>How to use middlewares in Vapor 4? - </title>
    <meta name="description" content="Learn how to create middlewares for a Vapor based server side Swift application to handle common routing functionalities.">
    
    <meta property="og:url" content="/posts/how-to-use-middlewares-in-vapor-4/">
    <meta property="og:title" content="How to use middlewares in Vapor 4? - ">
    <meta property="og:description" content="Learn how to create middlewares for a Vapor based server side Swift application to handle common routing functionalities.">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="How to use middlewares in Vapor 4? - ">
    <meta name="twitter:description" content="Learn how to create middlewares for a Vapor based server side Swift application to handle common routing functionalities.">
    
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

</head>

<body>
    <header id="navigation">
        <a id="site-logo" href="">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
        </a>
    
        <nav id="primary-menu">
            <input type="checkbox" id="primary-menu-button" name="menu-button" class="menu-button">
            <label for="primary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </label>
            <div class="menu-items">
                <a href="/">Home</a>
                <a href="/blog/">Blog</a>
                <a href="/posts/pages/1/">Posts</a>
                <a href="/authors/">Authors</a>
                <a href="/tags/">Tags</a>
                <a href="/my-page/">My page</a>
            </div>
        </nav>
    
        <nav id="secondary-menu">
            <input type="checkbox" id="secondary-menu-button" name="menu-button" class="menu-button">
            <label for="secondary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </label>
            <div class="menu-items right">
                <a href="#">My account</a>
                <a href="/">Logout</a>
            </div>
        </nav>
    </header>
        
    <main>

<article>
    <header>
        <section id="post-header" class="content-wrapper">
            <time datetime="2020-03-17 16:20:00">2020-03-17 16:20:00</time>
            <h1 class="title">How to use middlewares in Vapor 4?</h1>
            <p class="excerpt">Learn how to create middlewares for a Vapor based server side Swift application to handle common routing functionalities.</p>
        </section>
        
    </header>

    <section id="contents" class="content-wrapper">
    
    <h2>What is a middleware?</h2><p>A <a href="https://docs.vapor.codes/4.0/routing/#middleware" target="_blank">middleware</a> is basically a function that will be executed every time before the request handler. This way you can hook up special functionalities, such as altering the request before your handler gets the chance to respond to it. Let me show you a real-world example real quick.</p><pre><code class="language-swift">import Vapor

final class ExtendPathMiddleware: Middleware {

    public func respond(to request: Request, chainingTo next: Responder) -> EventLoopFuture<Response> {
        if !request.url.path.hasSuffix("/") {
            let response = request.redirect(to: request.url.path + "/", type: .permanent)
            return request.eventLoop.makeSucceededFuture(response)
        }
        return next.respond(to: request)
    }
}
</code></pre><p>I‚Äôm using this middleware to always extend my paths with a trailing slash character. Just try to delete the last char from the URL here on my site & press enter, you‚Äôll be redirected to the original path with a ‚Äú/‚Äù suffix, since the middleware is doing its job. üë®‚Äçüíª</p><p>A middleware function has two input parameters. The first one is the <code>Request</code> object that you can check or even alter its properties. The second one is the next reference in the <code>Responder</code> chain, so you can respond as usual (with your route handlers) if the middleware has nothing to do with the incoming request. You should always call the <code>next.respond(to: request)</code> method.</p><h2>Using a middleware</h2><p>In order to use the middleware from above you have to register it first. It is possible to use a middleware globally, you can hook up your middleware using the <code>app.middleware.use(_)</code> method. This way the registered middleware will be applided for every single route in your Vapor server.</p><pre><code class="language-swift">import Vapor

public func configure(_ app: Application) throws {
    // ...
    app.middleware.use(ExtendPathMiddleware())
}
</code></pre><p>The other option is to apply a middleware to specific subset of routes.</p><pre><code class="language-swift">let middlewareRoutes = app.grouped(ExtendPathMiddleware())
middlewareRoutes.get("hello") { req in
    return "hello"
}
</code></pre><p>You can read more about routing in the <a href="https://docs.vapor.codes/4.0/routing/" target="_blank">official Vapor 4 docs</a>. I also prefer to have a dedicated router class for my modules (I‚Äôm using kind of a VIPER architecture on the server side). üòú</p><pre><code class="language-swift">final class MyRouter: RouteCollection {

    func boot(routes: RoutesBuilder) throws {
        routes.grouped(ExtendPathMiddleware()).get("hello", use: self.hello)
    }
    
    func hello(req: Request) -> String {
        return "hello"
    }
}
// config
try app.routes.register(collection: routes)
</code></pre><p>That‚Äôs how I utilize middlewares in my Vapor apps. Honestly I don‚Äôt have that much custom middlewares, but the ones I implemented helps me a lot to solve common problems.</p><h2>Built-in middlewares</h2><p>There are some useful middlewares built right into Vapor.</p><h3>File middleware</h3><p>The <code>FileMiddleware</code> allows you to serve static assets from a given folder. This comes handy if you are using Vapor without an nginx server, so you can serve images, stylesheets, javascript files with the client (browser). You can setup the middleware like this:</p><pre><code class="language-swift">import Vapor

public func configure(_ app: Application) throws {
    // ...

    app.middleware.use(FileMiddleware(publicDirectory: app.directory.publicDirectory))
}
</code></pre><p>You can configure the path of your resources by passing the <code>publicDirectory</code> input parameter.</p><h3>CORS middleware</h3><p>In short, <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank">CORS</a> allows you to share resources between multiple domains.</p><blockquote><p>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources on a web page to be requested from another domain outside the domain from which the first resource was served.</p></blockquote><p>This comes handy if you are <a href="https://theswiftdev.com/how-to-create-your-first-website-using-vapor-4-and-leaf/" target="_blank">developing frontend apps by using Leaf & Vapor</a>. This middleware will replace or add the necessary CORS headerss to the response. You can use the default config or initialize a custom one, here is the Swift code for using the CORS middleware:</p><pre><code class="language-swift">import Vapor

public func configure(_ app: Application) throws {
    // ...
    
    // using default configuration
    app.middleware.use(CORSMiddleware(configuration: .default()))
    
    // using custom configuration
    app.middleware.use(CORSMiddleware(configuration: .init(
        allowedOrigin: .originBased,
        allowedMethods: [.GET, .POST, .PUT, .OPTIONS, .DELETE, .PATCH],
        allowedHeaders: [.accept, .authorization, .contentType, .origin, .xRequestedWith]
    )))
}
</code></pre><p>If you want to learn more about how these middlewares work you should option+click on the name of the middleware in Xcode. This way you can browse the source files directly. üîç</p><h3>Error middleware</h3><p>Route handlers can throw erros. You can catch those by using the <code>ErrorMiddlware</code> and turn them into proper HTTP responses if necessary. Here is how to setup the middleware:</p><pre><code class="language-swift">import Vapor

public func configure(_ app: Application) throws {
    // ...
    // using the default error handler
    app.middleware.use(ErrorMiddleware.default(environment: app.environment))
    
    // using a custom error handler
    app.middleware.use(ErrorMiddleware { req, error -> Response in
        // implement custom response...
        .init(status: .internalServerError, version: req.version, headers: .init(), body: .empty)
    })
}
</code></pre><p>If you are developing an API service, this middleware is kind of an essential component. üí•</p><h3>Auth related middlewares</h3><p>The <code>Authenticator</code> protocol conforms to the <code>Middleware</code> protocol, so we can register anything that implements any of the Authenticator protocols. You can read more about how the auth layer works in Vapor 4 from my <a href="https://theswiftdev.com/all-about-authentication-in-vapor-4/" target="_blank">authentication tutorial</a>.</p><p>The <code>Authenticatable</code> protocol has two static methods, they returns middlewares too. The first one is the guard middleware, which will throw an error if the user is not logged in. The second one is the redirect middleware, that redirects unauthenticated requests to the supplied path.</p><pre><code class="language-swift">// The UserModelAuthenticator is an Authenticator
app.routes.grouped(UserModelAuthenticator())

// The UserModel object is Authenticatable
app.routes.grouped([
    UserModel.guardMiddleware(),
    UserModel.redirectMiddleware(path: "/"),
])
</code></pre><p>Multiple middlewares can be registered at once using an array.</p><h2>Middlewares vs route handlers</h2><p>Sometimes it‚Äôs useful to write a middleware, but in other cases a simple route handler can be more than enough. I‚Äôm not against middlewares at all, but you should consider which approach is the best for your needs. I usually go with simple handlers and blocks in 95% of the cases.</p><p>Middlwares are good for solving global problems, for example if you want to add a new header to every request it‚Äôs safe to use a middleware. Checking user permission levels? Not necessary, but yeah if you want to simplify things a middleware could work here as well. ü§î</p><h2>Fun fact</h2><p>This URL: <code>https://www.google.com/////search?????client=safari&&&&&q=swift+vapor</code> still works, despite the fact that it contains 5 slashes, question marks and ampersands. I don‚Äôt know why, but most of the websites are not checking for duplicates. Try with other domains as well.</p><p>If you want to learn how to build a custom middleware I think it‚Äôs a good practice to solve this issue. Write one that removes the unnecessary characters and redirects to the ‚Äúright‚Äù URL.</p>
        
    </section>
    
    <h2>Next</h2>
    
    <h2>Prev</h2>
        <div class="post card">
            <a href="/posts/hummingbird-routing-and-requests/" target="">
                <figure>
                    <picture>
                        <img
                            src=""
                            alt=""
                            title=""
                        >
                    </picture>
                </figure>
                <section>
                    <time datetime="2023-03-17 16:20:00">2023-03-17 16:20:00</time>
                    <h2 class="title">Hummingbird routing and requests</h2>
                </section>
                <p>Beginner&#39;s guide to learn all about routing and request handling using the Hummingbird server-side Swift framework.</p>
            </a>
        
            
            
        
        </div>
    
    <h2>Related</h2>
    Empty.
    
    <h2>More by author(s)</h2>
    Empty.

</article>

    </main>

    <footer id="page-footer">
        <section class="content-wrapper">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
    
            <p>This site was generated using the <a href="https://swift.org/" target="_blank">Swift</a> programming language.</p>
            
            <p>
                <a href="https://binarybirds.com/">Home</a> ¬∑
                <a href="mailto:binarybirdsofficial@gmail.com">Email</a> ¬∑
                <a href="https://github.com/binarybirds/">GitHub</a> ¬∑
                <a href="https://x.com/tiborbodecs">Twitter</a> ¬∑
                <a href="/rss.xml" target="_blank">RSS</a> ¬∑
                <a href="/sitemap.xml" target="_blank">Sitemap</a>
            </p>
    
            <p class="small"> &copy; 2022 - 2024.</p>
        </section>
    </footer>
</body>
</html>
