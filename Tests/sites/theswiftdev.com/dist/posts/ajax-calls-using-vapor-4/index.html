<!DOCTYPE html>
<html >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>AJAX calls using Vapor 4 - </title>
    <meta name="description" content="Learn how to implement Asynchronous JavaScript and XML (AJAX) calls using Leaf templates and Vapor 4 as a server.">
    
    <meta property="og:url" content="/posts/ajax-calls-using-vapor-4/">
    <meta property="og:title" content="AJAX calls using Vapor 4 - ">
    <meta property="og:description" content="Learn how to implement Asynchronous JavaScript and XML (AJAX) calls using Leaf templates and Vapor 4 as a server.">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AJAX calls using Vapor 4 - ">
    <meta name="twitter:description" content="Learn how to implement Asynchronous JavaScript and XML (AJAX) calls using Leaf templates and Vapor 4 as a server.">
    
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon-180x180.png">

</head>

<body>
    <header id="navigation">
        <a id="site-logo" href="">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
        </a>
    
        <nav id="primary-menu">
            <input type="checkbox" id="primary-menu-button" name="menu-button" class="menu-button">
            <label for="primary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </label>
            <div class="menu-items">
                <a href="/">Home</a>
                <a href="/blog/">Blog</a>
                <a href="/posts/pages/1/">Posts</a>
                <a href="/authors/">Authors</a>
                <a href="/tags/">Tags</a>
                <a href="/about/">About</a>
            </div>
        </nav>
    
        <nav id="secondary-menu">
            <input type="checkbox" id="secondary-menu-button" name="menu-button" class="menu-button">
            <label for="secondary-menu-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="12" cy="5" r="1"></circle>
                    <circle cx="12" cy="19" r="1"></circle>
                </svg>
            </label>
            <div class="menu-items right">
                <a href="#">My account</a>
                <a href="/">Logout</a>
            </div>
        </nav>
    </header>
        
    <main>

<article>
    <header>
        <section id="post-header" class="content-wrapper">
            <time datetime="2020-12-18 16:20:00">2020-12-18 16:20:00</time>
            <h1 class="title">AJAX calls using Vapor 4</h1>
            <p class="excerpt">Learn how to implement Asynchronous JavaScript and XML (AJAX) calls using Leaf templates and Vapor 4 as a server.</p>
        </section>
        
    </header>

    <section id="contents" class="content-wrapper">
    
    <h2>What is AJAX?</h2><p>Asynchronous JavaScript and XML (<a href="https://en.wikipedia.org/wiki/Ajax_(programming)" target="_blank">AJAX</a>) is a technology that allows us you to send HTTP requests to your web server from a web page. Based on the response you can use JavaScript to manipulate the HTML Document Object Model (<a href="https://www.w3schools.com/whatis/whatis_htmldom.asp" target="_blank">DOM</a>). In short, with the help of AJAX, you can ask for some data, then you can update the contents of the web site based on that.</p><p>The good thing about AJAX is that you don‚Äôt have to reload the entire page, but you can update just a portion of the site. The HTTP request will work on the background so from a user perspective the whole browsing experience will seem faster, than a full page load. ‚åõÔ∏è</p><h3>Frontend vs backend</h3><p><a href="https://www.w3schools.com/whatis/whatis_ajax.asp" target="_blank">AJAX</a> is a frontend technology. It‚Äôs a simple JavaScript function call, but some smart people gave it a fancy name. The X in the name comes from the early days of the web, when servers usually returned a ‚Äúpre-rendered‚Äù partial HTML string that you could inject into the DOM without further data manipulation. Nowadays computers are so powerful that most of the servers can return JSON data and then the client can build the necessary HTML structure before the insertion.</p><p>In order to support AJAX calls on the server side we only have to implement the endpoint that the frontend can ask for. The communication is made through a standard HTTP call, so from a backend developer perspective we don‚Äôt really have to put any extra effort to support AJAX calls. üí™</p><h2>Creating the server</h2><p>Enough from the introduction, we now know what is AJAX and we are going to build a simple Vapor server to render our HTML document using Leaf Tau.</p><blockquote><p>NOTE: Tau was an experimental release, bit it was pulled from the final Leaf 4.0.0 release.</p></blockquote><p>Tau will be available later on as a standalone repository with some new features, until that you can still use it if you pin the Leaf dependency to the exact release tag‚Ä¶ ü§´</p><pre><code class="language-swift">// swift-tools-version:5.3
import PackageDescription

let package = Package(
    name: "myProject",
    platforms: [
       .macOS(.v10_15)
    ],
    dependencies: [
        .package(url: "https://github.com/vapor/vapor", from: "4.35.0"),
        .package(url: "https://github.com/vapor/leaf", .exact("4.0.0-tau.1")),
        .package(url: "https://github.com/vapor/leaf-kit", .exact("1.0.0-tau.1.1")),
    ],
    targets: [
        .target(
            name: "App",
            dependencies: [
                .product(name: "Leaf", package: "leaf"),
                .product(name: "LeafKit", package: "leaf-kit"),
                .product(name: "Vapor", package: "vapor"),
            ],
            swiftSettings: [
                .unsafeFlags(["-cross-module-optimization"], .when(configuration: .release))
            ]
        ),
        .target(name: "Run", dependencies: [.target(name: "App")]),
        .testTarget(name: "AppTests", dependencies: [
            .target(name: "App"),
            .product(name: "XCTVapor", package: "vapor"),
        ])
    ]
)
</code></pre><p>Open the project with Xcode and set a custom working directory for the executable target. First we are going to build a very simple <code>index.leaf</code> file, you should add it to the <code>Resources/Views</code> directory. If there is no such directory structure in your project yet, please create the necessary folders.</p><pre><code class="language-html"><!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AJAX example</title>
  </head>
  <body>
    <h1>AJAX example</h1>
    
    <button type="button" onclick="performAJAXCall()">Request data</button>

    <div id="container"></div>

    <script>
    function performAJAXCall() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            document.getElementById("container").innerHTML = this.responseText;
          }
      };
      xhttp.open("GET", "/ajax", true);
      xhttp.send();
    }
    </script>

  </body>
</html>
</code></pre><p>Now if you take a closer look at our <code>index.leaf</code> file, you should notice that this template is actually a perfectly valid HTML file. We don‚Äôt need anything special in order to perform AJAX calls, but only a few lines of HTML and JavaScript code.</p><p>We can use a simple button and use the <code>onclick</code> attribute to call a JavaScript function, in our case this function is defined between the script tags and it is called performAJAXCall, but of course you can change this name to anything you‚Äôd like to use.</p><p>We create <code>XMLHttpRequest</code> object and set the <code>onreadystatechange</code> property to a custom anonymous function. This is the response handler, it will be called when the server returned a response. You should check both the readyState property of the <code>XMLHttpRequest</code> object and the returned status code if you only want to perform some operation when a valid response arrived and the operation finished. In our case, we are going to update our container with the response text.</p><p>The very last step is to call the open method using a HTTP method as the first parameter, a URL as a second, and make it asynchronous with a third (true) boolean value. This will initialize the request, so we still have to use the send() function to actually send it to our web server.</p><p>We actually need a working Vapor server that can render the index page when you enter the <code>http://localhost:8080/</code> address to your browser. We also have to setup a new <code>/ajax</code> path and return some string that our frontend JavaScript code can place into the container HTML element, here‚Äôs one possible implementation of our backend application.</p><pre><code class="language-swift">import Vapor
import Leaf

public func configure(_ app: Application) throws {

    /// setup Leaf template engine
    LeafRenderer.Option.caching = .bypass
    app.views.use(.leaf)

    /// index route
    app.get { req in
        req.leaf.render(template: "index")
    }
    
    /// simple ajax response
    app.get("ajax") { req in
        "<strong>Lorem ipsum dolor sit amet</strong>"
    }
}
</code></pre><p>This is a 100% complete AJAX example using Vanilla JS (JavaScript without additional frameworks). It should work in most of the <a href="https://caniuse.com/?search=XMLHttpRequest" target="_blank">major browsers</a> and it‚Äôs just about 10 lines of code. üí™</p><h2>AJAX vs AJAJ</h2><p>Asynchronous JavaScript and JSON. Let‚Äôs be honest, this is the real deal and in 99% of the cases this is what you actually want to implement. First we‚Äôre going to alter our server and return a JSON response instead of the plain old HTML string. ü§Æ</p><pre><code class="language-swift">import Vapor
import Leaf

struct Album: Content {
    let icon: String
    let name: String
    let artist: String
    let year: String
    let link: String
}

public func configure(_ app: Application) throws {

    /// setup Leaf template engine
    LeafRenderer.Option.caching = .bypass
    app.views.use(.leaf)

    /// index route
    app.get { req in
        req.leaf.render(template: "index")
    }

    /// pretty simple ajaj response
    app.get("ajaj") { req  in
        [
            Album(icon: "‚ù§Ô∏è", name: "Amo", artist: "Bring me the Horizon", year: "2019", link: "https://music.apple.com/hu/album/amo/1439239477"),
            Album(icon: "üî•", name: "Black Flame", artist: "Bury Tomorrow", year: "2018", link: "https://music.apple.com/hu/album/black-flame/1368696224"),
            Album(icon: "üíé", name: "Pressure", artist: "Wage War", year: "2019", link: "https://music.apple.com/hu/album/pressure/1470142125"),
            Album(icon: "‚òÄÔ∏è", name: "When Legends Rise", artist: "Godsmack", year: "2018", link: "https://music.apple.com/hu/album/when-legends-rise/1440902339"),
            Album(icon: "üêò", name: "Eat the Elephant", artist: "A Perfect Circle", year: "2018", link: "https://music.apple.com/hu/album/eat-the-elephant/1340651075"),
        ]
    }
}
</code></pre><p>If you open the <code>http://localhost:8080/ajaj</code> URL you should see the returned JSON response. It is an array of the album objects, we are going to parse this JSON using JavaScript and display the results as a HTML structure.</p><pre><code class="language-html"><!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AJAX example</title>
    <style>
        .album {
            border: 1px solid gray;
            border-radius: 8px;
            margin: 16px;
            padding: 16px;
            text-align: center;
        }
    </style>
  </head>
  <body>
    <h1>AJAX example</h1>
    
    <button type="button" onclick="performAJAXCall()">Request data</button>

    <div id="container"></div>

    <script>
    function performAJAXCall() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
              var html = '';
              var albums = JSON.parse(this.responseText);
              if ( Array.isArray(albums) ) {
                  albums.forEach(function(album, index) {
                      html += '<div class="album">'
                      html += '<h1>' + album.icon + '</h1>';
                      html += '<h2>' + album.name + '</h2>';
                      html += '<p>' + album.artist + '</p>';
                      html += '<a href="' + album.link + '" target="_blank">Listen now</a>'
                      html += '</div>'
                  });
              }
              document.getElementById("container").innerHTML = html;
          }
      };
      xhttp.open("GET", "/ajaj", true);
      xhttp.send();
    }
    </script>

  </body>
</html>
</code></pre><p>The <code>XMLHttpRequest</code> method remains the same, but now take advantage of the built-in <code>JSON.parse</code> JavaScript function. This can parse any JSON object and returns the parsed object. We should always check if the result is the right type that we want to work with (in our case we only accept an array). Then we can use the properties of the album objects to construct our HTML code.</p><p>I‚Äôm not doing further validations and type checking, but you should always ensure that objects are not nil or undefined values. Anyway, this example shows us how to perform an AJAJ call, parse the response JSON and display the result in a nice way. üòÖ</p>
        
    </section>
    
    <h2>Next</h2>
    
    <h2>Prev</h2>
        <div class="post card">
            <a href="/posts/hummingbird-routing-and-requests/" target="">
                <figure>
                    <picture>
                        <img
                            src=""
                            alt=""
                            title=""
                        >
                    </picture>
                </figure>
                <section>
                    <time datetime="2023-03-17 16:20:00">2023-03-17 16:20:00</time>
                    <h2 class="title">Hummingbird routing and requests</h2>
                </section>
                <p>Beginner&#39;s guide to learn all about routing and request handling using the Hummingbird server-side Swift framework.</p>
            </a>
        
            
            
        
        </div>
    
    <h2>Related</h2>
    Empty.
    
    <h2>More by author(s)</h2>
    Empty.

</article>

    </main>

    <footer id="page-footer">
        <section class="content-wrapper">
            <figure>
                <picture>
                    <source
                        srcset="/images/logos/logo~dark.png"
                        media="(prefers-color-scheme: dark)"
                    >
                    <img
                        id="logo-image"
                        src="/images/logos/logo.png"
                        alt="Logo of "
                        title=""
                    >
                </picture>
            </figure>
    
            <p>This site was generated using the <a href="https://swift.org/" target="_blank">Swift</a> programming language.</p>
            
            <p>
                <a href="https://binarybirds.com/">Home</a> ¬∑
                <a href="mailto:binarybirdsofficial@gmail.com">Email</a> ¬∑
                <a href="https://github.com/binarybirds/">GitHub</a> ¬∑
                <a href="https://x.com/tiborbodecs">Twitter</a> ¬∑
                <a href="/rss.xml" target="_blank">RSS</a> ¬∑
                <a href="/sitemap.xml" target="_blank">Sitemap</a>
            </p>
    
            <p class="small"> &copy; 2022 - 2024.</p>
        </section>
    </footer>
</body>
</html>
